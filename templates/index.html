<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Wisata AI Balikpapan (A*)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; display: flex; height: 100vh; }
        #sidebar { width: 350px; background: #f8f9fa; padding: 20px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); z-index: 1000; display: flex; flex-direction: column; }
        #map { flex-grow: 1; }
        h2 { color: #2c3e50; margin-top: 0; }
        .control-group { margin-bottom: 20px; }
        label { font-weight: bold; display: block; margin-bottom: 5px; color: #555; }
        button#btn-cari {
            background: #3498db; color: white; border: none; padding: 12px; width: 100%;
            border-radius: 5px; font-size: 16px; cursor: pointer; transition: 0.3s;
        }
        button#btn-cari:hover { background: #2980b9; }
        #result-card {
            margin-top: 20px; padding: 15px; background: white; border-radius: 8px;
            border-left: 5px solid #2ecc71; display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .loading { color: #e67e22; font-weight: bold; display: none; margin-top: 10px; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>üó∫Ô∏è Pencari Rute Wisata</h2>
    <p style="font-size: 0.9em; color: #666;">Pilih titik lewat peta atau pencarian.</p>

    <div class="control-group">
        <label>üìç Titik Awal</label>
        <select id="start-select" placeholder="Pilih lokasi awal..."></select>
    </div>

    <div class="control-group">
        <label>üèñÔ∏è Destinasi</label>
        <select id="dest-select" multiple placeholder="Klik peta atau cari..."></select>
    </div>

    <button id="btn-cari" onclick="hitungRute()">Temukan Rute Perjalanan</button>
    <div id="loading" class="loading">Menghitung rute...</div>

    <div id="result-card">
        <h3 style="margin:0 0 10px 0;">Hasil Perhitungan</h3>
        <div id="result-content"></div>
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<script>
    // --- 1. SETUP PETA ---
    var map = L.map('map').setView([-1.2480, 116.8600], 13); // Fokus Balikpapan
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    var routeLayer = null;
    var markers = {}; // Simpan referensi marker {id: markerObj}

    // Icons
    var iconGrey = L.icon({iconUrl: '/static/assets/marker-icon-grey.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]});
    var iconGreen = L.icon({iconUrl: '/static/assets/marker-icon-green.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]});
    var iconRed = L.icon({iconUrl: '/static/assets/marker-icon-red.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]});

    // Global TomSelect Instances
    var tsStart, tsDest;

    // --- 2. LOAD DATA ---
    fetch('/api/pois')
        .then(res => res.json())
        .then(data => {
            initApp(data);
        });

    function initApp(pois) {
        // Format data untuk TomSelect
        var options = pois.map(p => ({value: p.id, text: p.name}));

        // Init TomSelect (Biarkan kode ini seperti sebelumnya...)
        tsStart = new TomSelect("#start-select", {
            options: options, maxItems: 1,
            onChange: function(val) { updateMarkers(); }
        });

        tsDest = new TomSelect("#dest-select", {
            options: options, maxItems: 10, plugins: ['remove_button'],
            onChange: function(val) { updateMarkers(); }
        });

        // === PERBAIKAN UTAMA DI SINI ===
        
        // 1. Inisialisasi Marker Cluster Group
        // Ini akan otomatis mengelompokkan marker yang berdekatan
        var markersLayer = L.markerClusterGroup({
            disableClusteringAtZoom: 16, // Di zoom level 16, semua titik akan pecah (terlihat)
            spiderfyOnMaxZoom: true
        });

        // 2. Loop POI
        pois.forEach(p => {
            // Kita pakai Icon default dulu jika custom icon bermasalah, 
            // atau pastikan internet lancar untuk load icon custom.
            // Jika ingin tetap pakai icon custom, pastikan URL-nya benar.
            
            var m = L.marker([p.lat, p.lon], {icon: iconGrey}); 
            
            // Bind Tooltip (Nama muncul saat hover)
            m.bindTooltip(p.name, {direction: 'top', offset: [0,-30]});

            // Interaksi Klik
            m.on('click', function() {
                var idStr = String(p.id);
                if (!tsStart.getValue()) {
                    tsStart.setValue(idStr);
                } else if (tsDest.getValue().includes(idStr)) {
                    tsDest.removeItem(idStr);
                } else if (tsStart.getValue() !== idStr) {
                    tsDest.addItem(idStr);
                }
            });

            // Simpan referensi marker di object markers
            markers[p.id] = m;

            // Masukkan marker ke Cluster Group, BUKAN langsung ke map
            markersLayer.addLayer(m);
        });

        // 3. Tambahkan Layer Cluster ke Peta
        map.addLayer(markersLayer);
        
        // Simpan referensi cluster layer agar bisa dihapus/refresh jika perlu
        // window.markersLayer = markersLayer; 
    }

    // --- 3. UPDATE WARNA MARKER ---
    function updateMarkers() {
        var startId = tsStart.getValue();
        var destIds = tsDest.getValue(); // Array of strings

        for (var id in markers) {
            var m = markers[id];
            
            if (id === startId) {
                m.setIcon(iconRed); // Titik Awal = Merah
                m.setZIndexOffset(1000);
            } else if (destIds.includes(id)) {
                m.setIcon(iconGreen); // Destinasi = Hijau
                m.setZIndexOffset(900);
            } else {
                m.setIcon(iconGrey); // Netral = Abu
                m.setZIndexOffset(0);
            }
        }
    }

    // --- 4. HITUNG RUTE (Panggil Flask A*) ---
    function hitungRute() {
        var startId = tsStart.getValue();
        var destIds = tsDest.getValue();

        if (!startId || destIds.length === 0) {
            alert("Pilih minimal 1 titik awal dan 1 destinasi!");
            return;
        }

        document.getElementById('loading').style.display = 'block';
        document.getElementById('result-card').style.display = 'none';
        if(routeLayer) map.removeLayer(routeLayer);

        fetch('/api/route', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                start_id: parseInt(startId),
                dest_ids: destIds.map(id => parseInt(id))
            })
        })
        .then(res => res.json())
        .then(data => {
            document.getElementById('loading').style.display = 'none';
            
            if (data.error) {
                alert("Error: " + data.error);
                return;
            }

            // Gambar Garis Rute
            routeLayer = L.geoJSON(data.geojson, {
                style: {color: '#3498db', weight: 6, opacity: 0.8}
            }).addTo(map);

            map.fitBounds(routeLayer.getBounds(), {padding: [50,50]});

            // Tampilkan Info
            document.getElementById('result-card').style.display = 'block';
            document.getElementById('result-content').innerHTML = `
                <div><b>Total Jarak:</b> ${data.total_km} KM</div>
                <div style="font-size:0.9em; margin-top:5px; color:#666;">Rute mencakup ${destIds.length} tempat wisata.</div>
            `;
        })
        .catch(err => {
            console.error(err);
            document.getElementById('loading').style.display = 'none';
            alert("Gagal menghubungi server.");
        });
    }
</script>

</body>
</html>